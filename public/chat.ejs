<%include header%>
<head>
  <link rel=stylesheet type="text/css" href="chat.css">
</head>
<body>
    <div class="top">
        <span id="user" style="float:left; font-size:1.5em;"><%= username %></span>
        <span style="font-size:3em; font-family:Cursive;">CNLine</span>
        <span style="float:right;">&nbsp;<input type="submit" value="登出" onclick="location.href='/login'"></span>
    </div>
    <div class="left">
        <table width="100%">
            <% for( var idx = 0; idx < userlist.length; idx++) { %>
                <% if(idx % 2 === 0) { %>
                    <tr><td class="name_even name_offline"  onclick=openRoom(this) id=<%= userlist[idx].id %>><%= userlist[idx].username %></td></tr>
                <% } %>
                <% if(idx % 2 === 1) { %>
                    <tr><td class="name_odd name_offline" onclick=openRoom(this) id=<%= userlist[idx].id %>><%= userlist[idx].username %></td></tr>
                <% } %>
            <% } %>
        </table>
    </div>
    <div class="main" id="chatRoom">
        <div id="roomName" style="height:30px; width:100%; border-bottom:2px solid; text-align:center; font-size:1.25em"></div>
        <div id="chatContentDiv" style="position:absolute; top:40px; bottom:60px; width:100%; overflow:auto;">
            <table id="chatContent" style="padding-left:50px;">
            </table>
        </div>
        <table style="height:60px; width:100%; position:absolute; bottom:0px;">
            <tr>
                <td>
                    <div class="fileUpload">
                        <span>檔案</span>
                        <input id="file" class="upload" type="file" value="檔案" onchange=uploadFile() multiple>
                    </div>
                </td>
                <td style="width:100%;"><input id="message" type="text" autofocus style="width:100%; font-size:1.25em;" maxlength="100"></td>
                <td><input type="button" value="傳送" onclick=sendMsg() style="font-size:1.25em; margin:10px;"></td>
            </tr>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./js/delivery.js"></script>
    <script>
        var socket = io();
        var delivery = new Delivery(socket);
        var opened_id = -1;
        function openRoom(group) {
            console.log("open room " + group.id);
            opened_id = group.id;
            if($("#roomName").text() == group.innerHTML){
                return;
            }
            $("#roomName").text(group.innerHTML);
            $("#chatRoom").hide();
            $("#chatContent tr").remove();
            $("#chatRoom").show("fast");
            socket.emit('open room', opened_id);
        }
        function uploadFile() {
            var files = document.getElementById("file").files;
            console.log(files);
            var names="";
            for(var i = 0; i < files.length; i++)  {
                console.log(files[i].name);
                names += files[i].name;
            }
            $("#message").val(names);
        }
        $("#message").keydown( function(event){
            if (event.keyCode == 13) {
                sendMsg();
            }
        });
        function sendMsg() {
            if ($("#message").val() != "") {
                $("#chatContent").append(
                    $("<tr>").append(
                        $("<td>").text(
                            $("#user").text() + ": " + $("#message").val()
                        )
                    )
                );
                var objDiv = document.getElementById("chatContentDiv");
                objDiv.scrollTop = objDiv.scrollHeight;
                var new_message = {
                    to: opened_id,
                    msg: $("#user").text() + ": " + $("#message").val()
                };
                console.log(new_message);
                socket.emit('new message', new_message);
                $("#message").val("");
            }
            var files = document.getElementById("file").files;
            if(files.length > 0) {
                for(var i = 0; i < files.length; i++)  {
                    delivery.send(files[i]);
                }
                $("#file").val("");
            }
        }
        delivery.on("send.success", function(fileUID) {
            console.log(fileUID + "file sent successfully.");
            var new_message = {
                to: opened_id,
                fileUID: fileUID
            };
            console.log(new_message);
            socket.emit('file sent', new_message, function() {
            });
        });
        socket.on('file incoming', function (sender_id) {

        });
        socket.on('broadcast msg', function (data) {
            if(data.sender_id == opened_id && $("#"+data.sender_id).text() != $("#user")){
                $("#chatContent").append(
                    $("<tr>").append(
                        $("<td>").text(
                            data.msg
                        )
                    )
                );
                var objDiv = document.getElementById("chatContentDiv");
                objDiv.scrollTop = objDiv.scrollHeight;
            }
        });
        socket.on('online', function (id) {
            $("#"+id).removeClass('name_offline');
            $("#"+id).addClass('name_online');
        });
        socket.on('offline', function (id) {
            $("#"+id).removeClass('name_online');
            $("#"+id).addClass('name_offline');
        });
        socket.on('log response', function (data) {
            if(data.uid == opened_id){
                data.log_msg.forEach(function(obj) {
                    $("#chatContent").append(
                        $("<tr>").append(
                            $("<td>").text(
                               obj.msg
                            )
                        )
                    );
                });
                var objDiv = document.getElementById("chatContentDiv");
                objDiv.scrollTop = objDiv.scrollHeight;
            }
        });
    </script>
</body>
